---
output:
 pdf_document:
  toc: FALSE
---

```{r setup, include=FALSE}

library(rmarkdown)
library(readxl)
library(knitr)
library(tinytex)
library(kableExtra)
library(RColorBrewer)

library(tidyverse)
library(stringr)
library(treemap)
library(maditr)
library(here)		 

options(knitr.table.format = "latex")
knitr::opts_chunk$set(echo = FALSE)

unlink(here("outputs",ID),recursive = T)
dir.create(here("outputs",ID))
outdir<-ID
dir.create(here("outputs",ID,"/summary"))
dir.create(here("outputs",ID,"/summary/data"))
dir.create(here("outputs",ID,"/raw"))
dir.create(here("outputs",ID,"/raw/data"))

raab<-read.csv(here("data","raabs_618.csv"))
raab<-raab[raab$raab_id==ID,]

pop_merged<-read.csv(here("data","raabs_pop_618.csv"))
popfives<-pop_merged[pop_merged$raab_id==ID,]

# meta<-read.csv(here("data","historic_meta.csv"),check.names=F)
meta<-read_xlsx(here("data","historic_meta_log.xlsx"), sheet=1, na=c("",NA))
							 									 
vars_to_drop<-c("map_complete","exclude_repo","repo_meta","repo_data","ecsc_consent","x4_data_access","data_lost","hl_permission_doc","hl_permission_localreport","hl_permission_raabreport","hl_permission_raabdata","hl_findingspublishedjournal","hl_findingslocalreport","hl_ethicscommitteeapproval","hl_permission_detail","hl_on_behalf_of","permission_ref","lshtm_dta","lshtm_dta-Ref","pi_email1", "pi_email2", "pi_email1 active","pi_email NOTES","pi_int_auth_grp", "trainer_email", "trainer_email2")

raab_meta<-meta[meta$raab_id==ID,!(names(meta) %in% vars_to_drop)]

meta_report<-data.frame(
  title=NA,
  creator="International Centre for Eye Health",
  subject="Eye Diseases; Vision Disorders; Cataract; Cataract Extraction; Refractive errors; Health Services Research; Health Surveys",
  subjectVocab="MeSH",
  description="A report including output of standardised analysis of vision and eye health survey data including tables of vision impairment prevalence and service coverage estimates",
  publisher="London School of Hygiene & Tropical Medicine RAAB Repository",
  contributor="",
  date=format(Sys.time(), '%Y-%m-%d'),
  type="Text",
  format="pdf",
  identifier=NA,
  doi=NA,
  source=NA,
  language="eng",
  relation=NA,
  coverage=NA,
  rights="This work is licensed under CC BY-NC-SA 4.0. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/",
  bibliographicCitation=NA)

meta_dataset<-data.frame(
  title=NA,
  creator=NA,
  subject="Eye Diseases; Vision Disorders; Cataract; Cataract Extraction; Refractive errors; Health Services Research; Health Surveys",
  subjectVocab="MeSH",
  description="Anonymous participant level dataset including variables for visual acuity, spectacle use, lens status, cause of vision impairment, cataract surgical history, barriers to cataract surgery and population count data for five-year age-gender groups for males and females 50 years and older",
  publisher="London School of Hygiene & Tropical Medicine RAAB Repository",
  contributor=NA,
  date=format(Sys.time(), '%Y-%m-%d'),
  type="Dataset",
  format="csv",
  identifier=NA,
  doi=NA,
  source=NA,
  language="eng",
  relation=NA,
  coverage=NA,
  rights="This work is licensed under CC BY-NC-ND 4.0. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-nd/4.0/",
  bibliographicCitation=NA)

meta_report$title<-paste0("Rapid Assessment of Avoidable Blindness Report: ",raab_meta$survey_title)
meta_dataset$title<-paste0("Rapid Assessment of Avoidable Blindness Dataset: ",raab_meta$survey_title)

meta_dataset$creator<-raab_meta$pi_name
meta_dataset$date<-raab_meta$year_end

url_string<-gsub("[[:punct:]]", "", raab_meta$survey_title)
url_string<-gsub(" ", "-", tolower(url_string))

meta_report$identifier<-paste0("https://www.raab.world/survey/",url_string,"/report")
meta_dataset$identifier<-paste0("https://www.raab.world/survey/",url_string,"/data")

meta_report$doi<-paste0("10.17037/RAABREPORT.",formatC(as.numeric(row.names(raab_meta)),width=8,format = "d",flag="0"))
meta_dataset$doi<-paste0("10.17037/RAABDATASET.",formatC(as.numeric(row.names(raab_meta)),width=8,format = "d",flag="0"))

meta_report$source<-paste0("Rapid Assessment of Avoidable Blindness Dataset: ",raab_meta$survey_title)
meta_dataset$relation<-paste0("Rapid Assessment of Avoidable Blindness Report: ",raab_meta$survey_title)

meta_report$bibliographicCitation<-paste0(
  meta_report$creator,
  ". (",
  format(Sys.time(), '%Y'),
  "). ",
  meta_report$title,
  ". ",
  meta_report$publisher,
  ". DOI: https://www.doi.org/",
  meta_report$doi)

meta_dataset$bibliographicCitation<-paste0(
  meta_dataset$creator,
  ". (",
  meta_dataset$date,
  "). ",
  meta_dataset$title,
  ". ",
  meta_dataset$publisher,
  ". DOI: https://www.doi.org/",
  meta_dataset$doi)

PI<-raab_meta$pi_name
TITLE<-raab_meta$survey_title

write.table(raab_meta, here("outputs", ID, "raw", "meta.csv"),row.names=F,col.names=T,sep=",",na="")
write.table(meta_report, here("outputs", ID, "raw", "meta_report.csv"),row.names=F,col.names=T,sep=",",na="")
write.table(meta_dataset, here("outputs", ID, "raw", "meta_dataset.csv"),row.names=F,col.names=T,sep=",",na="")
write.table(raab, here("outputs", ID, "raw", "data", "survey_data.csv"),row.names=F,col.names=T,sep=",")
write.table(popfives, here("outputs", ID, "raw", "data","population.csv"),row.names=F,col.names=T,sep=",")

source(here("RAAB5_scripts", "raab_functions.R"))

```

---
title: |
 <center>Rapid Assessment of Avoidable Blindness
subtitle: Report of findings from `r TITLE`
author: Principal Investigator `r PI`
output:
 pdf_document:
  toc: FALSE
tables:
 yes
header-includes:
- \usepackage{float}
- \usepackage{tabu}
- \usepackage{graphicx}
---

```{r raab_report_setup, include=FALSE}

source("RAAB5_report_setup.R")

```

\center

Report generated: `r format(Sys.time(), '%d %B %Y')`

\raggedright

```{=latex}
\tableofcontents
```

\newpage

# Sample representation

## Response rate

```{r sum1, echo=FALSE}

source(here("RAAB5_scripts","response-rate.R"))

sum1.nice.names<-sum1

write.table(sum1.nice.names, here("outputs", ID, "summary","data","pop1.csv"),row.names=F,col.names=T,sep=",")

names(sum1.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(sum1.nice.names, booktabs=T, linesep = "", caption = "Eligible persons, coverage, absentees and refusals (POP1)", align='lcccccc') %>% 
  kable_styling(full_width=T,latex_options = "HOLD_position",font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(4,hline_after=T) %>%
  add_header_above(c("Exam status" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T) %>%
  add_footnote("The response rate is the percent examined",notation="symbol")

```

The response rate indicates the proportion of eligible, enumerated people who were examined.  The RAAB sample size calculator includes the expected non-response rate in the sample and increases the sample size accordingly. This ensures that the sample size is powerful enough to estimate the prevalence of blindness with the desired precision. 

If the response rate is lower than 80-90%, there is a concern that the conditions under review in the 10-20% who were not examined may be different to those that were examined (non-response bias). For example, non-responders in a RAAB may be younger than responders (e.g., working age vs retired) and may, on average, be less likely to be vision impaired. 

If the response rate is over 95%, this might be an indication that eligible participants who were absent or refused to participate were not enumerated but rather replaced by eligible participants in the next household, which would introduce selection bias and mean that results are not representative of the population. For example, people with impaired vision may be more likely to be at home and people with good vision may be more likely to be away and unavailable. In certain settings (e.g., rural or remote) a response rate over 95% is not uncommon – participants may be more compliant with requests to stay home on the day of data collection, or more likely to work in the environment close to their home.

It is important to review this information in relation to the tables on representativeness of the sample below to identify whether a high response rate is valid.

## Sample representativeness

```{r asa1, echo=FALSE}

source(here("RAAB5_scripts","sample-age-gender.R"))

asa1.nice.names<-asa1[,c("age.groups.tens","female.examined.n","female.examined.pct","male.examined.n","male.examined.pct","total.examined.n","total.examined.pct")]

write.table(asa1.nice.names,here("outputs", ID, "summary", "data", "pop2.csv"),row.names=F,col.names=T,sep=",")

names(asa1.nice.names)<-c("Years","n","%","n","%","n","%")

knitr::kable(asa1.nice.names, booktabs=T, linesep = "", caption = "Age and sex distribution of people examined in the sample (POP2)", align='lcccccc') %>% 
  kable_styling(full_width=T,latex_options = "HOLD_position",font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(4,hline_after=T) %>%
  add_header_above(c("Age group" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T)


```

```{r asa2, echo=FALSE}

source(here("RAAB5_scripts","pop-age-gender.R"))

asa2.nice.names<-asa2

write.table(asa2.nice.names,here("outputs", ID, "summary", "data", "pop3.csv"),row.names=F,col.names=T,sep=",")

names(asa2.nice.names)<-c("Years","n","%","n","%","n","%")

knitr::kable(asa2.nice.names, booktabs=T, linesep = "", caption = "Total number of people aged 50+ years in survey area (POP3)", align='lcccccc') %>% 
  kable_styling(full_width=T,latex_options = "HOLD_position",font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(4,hline_after=T) %>%
  add_header_above(c("Age group" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T)

```


```{r asa1_2_plots, echo=FALSE, fig.height=3.25, fig.fullwidth=T}

fasa12 <- rbind(as.numeric(asa2$female.pct[1:4]), as.numeric(asa1$female.examined.pct[1:4]))
masa12 <- rbind(as.numeric(asa2$male.pct[1:4]), as.numeric(asa1$male.examined.pct[1:4]))

par(mfrow=c(1,2))

bp1<-barplot(as.matrix(fasa12),beside=T,horiz=T,yaxt='n',xaxt='n',col=c("grey","purple"),border = "white",xlab="Proportion (%)",ylab="Age group (years)",cex.lab=0.6,ylim=c(0,16))
axis(1,at=c(-10,0,10,20,30,40,50,60,70,80,90,100),labels=c(-10,0,10,20,30,40,50,60,70,80,90,100),cex.axis=0.6)
axis(2,at=c(2,5,8,11,30),labels = NA,tick=F)
text(x=par("usr")[3]-6, y=c(2,5,8,11), labels=c("50-59","60-69","70-79","80+"), xpd=NA, srt=325, cex=0.6)
legend("top",col=c("purple","grey"),pch=15,c("Survey sample","Census population"),bty='n',cex=0.6,title = expression(bold("Females")),horiz=T,title.adj=0)

bp2<-barplot(as.matrix(masa12),beside=T,horiz=T,yaxt='n',xaxt='n',col=c("grey","gold"),border = "white",xlab="Proportion (%)",ylab="Age group (years)",cex.lab=0.6,ylim=c(0,16))
axis(1,at=c(-10,0,10,20,30,40,50,60,70,80,90,100),labels=c(-10,0,10,20,30,40,50,60,70,80,90,100),cex.axis=0.6)
axis(2,at=c(2,5,8,11,30),labels = NA,tick=F)
text(x=par("usr")[3]-6, y=c(2,5,8,11), labels=c("50-59","60-69","70-79","80+"), xpd=NA, srt=325, cex=0.6)
legend("top",col=c("gold","grey"),pch=15,c("Survey sample","Census population"),bty='n',cex=0.6,title=expression(bold("Males")),horiz=T,title.adj=0)

```


```{r asa1_extra_plot, echo=FALSE, fig.height=3.25, fig.fullwidth=T}

fasa1x<-as.matrix(t(asa1[1:4,c("female.examined.pct","female.nonresponse.pct")]))
masa1x<-as.matrix(t(asa1[1:4,c("male.examined.pct","male.nonresponse.pct")]))

par(mfrow=c(1,2))

bp3<-barplot(fasa1x,horiz=T,yaxt='n',xaxt='n',col=c("white","purple"),border = "purple",xlab="Proportion (%)",ylab="Age group (years)",cex.lab=0.6,ylim=c(0,6))
axis(1,at=c(-10,0,10,20,30,40,50,60,70,80,90,100),labels=c(-10,0,10,20,30,40,50,60,70,80,90,100),cex.axis=0.6)
axis(2,at=bp3[1:4],labels = NA,tick=F)
text(x=par("usr")[3]-6, y=bp3[1:4], labels=c("50-59","60-69","70-79","80+"), xpd=NA, srt=325, cex=0.6)
legend("top",col="purple",pch=c(0,15),c("Examined","Non-responders"),bty='n',cex=0.6,title = expression(bold("Enumerated females")),horiz=T,title.adj=0)

bp4<-barplot(masa1x,horiz=T,yaxt='n',xaxt='n',col=c("white","gold"),border = "gold",xlab="Proportion (%)",ylab="Age group (years)",cex.lab=0.6,ylim=c(0,6))
axis(1,at=c(-10,0,10,20,30,40,50,60,70,80,90,100),labels=c(-10,0,10,20,30,40,50,60,70,80,90,100),cex.axis=0.6)
axis(2,at=bp4[1:4],labels = NA,tick=F)
text(x=par("usr")[3]-6, y=bp4[1:4], labels=c("50-59","60-69","70-79","80+"), xpd=NA, srt=325, cex=0.6)
legend("top",col="gold",pch=c(0,15),c("Examined","Non-responders"),bty='n',cex=0.6,title=expression(bold("Enumerated males")),horiz=T,title.adj=0)

```

For your results to be useful for planning, your sample needs to be representative of the population 50 years and older. After completing the survey, we can assess representativeness by comparing the age-sex composition of the sample to the age-sex composition of the population 50 years and older. 

We can also use the age-sex composition of the population 50 years and older to weight (post-stratify) crude estimates and provide age-sex adjusted (ASA) estimates for the population. We apply an ‘inflation factor’ – derived from sample vs population comparisons – to the counts of our conditions of interest in each sample age-sex group to generate extrapolated values in the population. 

Often, there are more older females than younger males in the sample, and less younger males in the sample than in the population, because men are more likely to be away at work when the survey teams visit. If this is the case, use the age-sex adjusted estimates.

Important: if your sample differs from the population because one group was more likely to be unavailable (e.g., younger men, or other seasonal labourers) then you would expect to see this reflected in the response rate (i.e., more people enumerated but unavailable).  If the difference between the sample and the population is high, but the proportion of people unavailable is low (e.g., response rate is still above 95%) this might be an indication that eligible participants who were absent or refused were replaced by others, which introduces bias and may mean that results are not accurate.

\newpage

# Prevalence and causes of distance vision impairment

We report the prevalence of distance vision impairment (VI) in the population 50 years and older using presenting visual acuity (PVA) in the better eye. PVA is visual acuity measured with correction, if available.

Distance vision impairment categories are defined according to the VA thresholds used in the World Health Organization’s International Classification of Diseases (ICD-11).

Blindness: PVA less than 3/60 in the better eye

Severe VI: PVA less than 6/60 to 3/60 in the better eye

Moderate VI: PVA less than 6/18 to 6/60 in the better eye

Mild VI: PVA less than 6/12 to 6/18 in the better eye

## Distance vision impairment prevalence

```{r sum3, echo=FALSE}

source(here("RAAB5_scripts","crude-adj-prev-vi_RAAB5.R"))

sum3.nice.names<-sum3

sum3.nice.names$vi.level<-as.character(sum3.nice.names$vi.level)
sum3.nice.names$vi.level[sum3.nice.names$vi.level=="blind"]<-"Blind"
sum3.nice.names$vi.level[sum3.nice.names$vi.level=="severe.vi"]<-"Severe"
sum3.nice.names$vi.level[sum3.nice.names$vi.level=="moderate.vi"]<-"Moderate"
sum3.nice.names$vi.level[sum3.nice.names$vi.level=="mild.vi"]<-"Mild"

sum3.nice.names$female.adj.ci<-paste0(sum3.nice.names$female.adj.pct.lci," - ",sum3.nice.names$female.adj.pct.uci)
sum3.nice.names$male.adj.ci<-paste0(sum3.nice.names$male.adj.pct.lci," - ",sum3.nice.names$male.adj.pct.uci)
sum3.nice.names$total.adj.ci<-paste0(sum3.nice.names$total.adj.pct.lci," - ",sum3.nice.names$total.adj.pct.uci)
sum3.nice.names$female.ci<-paste0(sum3.nice.names$female.pct.lci," - ",sum3.nice.names$female.pct.uci)
sum3.nice.names$male.ci<-paste0(sum3.nice.names$male.pct.lci," - ",sum3.nice.names$male.pct.uci)
sum3.nice.names$total.ci<-paste0(sum3.nice.names$total.pct.lci," - ",sum3.nice.names$total.pct.uci)

sum3a.nice.names<-sum3.nice.names[,c("vi.level","female.n","female.pct","female.ci","male.n","male.pct","male.ci","total.n","total.pct","total.ci")]

write.table(sum3a.nice.names,here("outputs", ID, "summary", "data", "prev1.csv"),row.names=F,col.names=T,sep=",")

names(sum3a.nice.names)<-c("","n","%","95% CI","n","%","95% CI","n","%","95% CI")

knitr::kable(sum3a.nice.names, booktabs=T, linesep = "", caption = "Crude prevalence of blindness, severe and moderate vision impairment (PREV1)", align='lccccccccc') %>% 
  kable_styling(full_width=T,latex_options="HOLD_position",font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  add_header_above(c("VI level" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold=T) %>% 
  add_footnote("Participants not tested at 6/12",notation="symbol")

```


```{r sum4, echo=FALSE}

sum3b.nice.names<-sum3.nice.names[,c("vi.level","female.adj.pct","female.adj.ci","extrapolated.female.n","male.adj.pct","male.adj.ci","extrapolated.male.n","total.adj.pct","total.adj.ci","extrapolated.total.n")]

write.table(sum3b.nice.names,here("outputs", ID, "summary", "data", "prev2.csv"),row.names=F,col.names=T,sep=",")

names(sum3b.nice.names)<-c("","%","95% CI","Extraplotated magnitude","%","95% CI","Extrapolated magnitude","%","95% CI","Extrapolated magnitude")

knitr::kable(sum3b.nice.names, booktabs=T, linesep = "", caption = "Adjusted prevalence and extrapolated magnitude of blindness, severe and moderate vision impairment (PREV2)", align='lccccccccc') %>% 
  kable_styling(latex_options=c("scale_down","HOLD_position"), font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(c(4,7,10),width='2cm') %>%
  add_header_above(c("VI level" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold=T) %>%
  add_footnote("Participants not tested at 6/12",notation="symbol")

```

These tables show the crude and adjusted prevalence of vision impairment by impairment level and gender. The sample size for RAAB is calculated to provide an acceptable level of precision for the total prevalence of blindness. The accuracy of prevalence estimates for population subgroups is lower and caution should be taken in the interpretation of these data. Table PREV2 shows the estimated magnitude of vision impairment in the study area by gender, calculated by multiplying the crude prevalence by the population count (e.g., census data). Throughout, the 95% confidence intervals are calculated to account for RAAB's cluster sampling design.

## Cumulative distance vision impairment prevalence

```{r asa6, echo=FALSE}

source(here("RAAB5_scripts","crude-adj-cum-prev-vi_RAAB5.R"))

asa6.nice.names<-asa6
asa6.nice.names$vi.level<-as.character(asa6.nice.names$vi.level)

asa6.nice.names$vi.level[asa6.nice.names$vi.level=="mild.cumulative"]<-"Mild or worse"
asa6.nice.names$vi.level[asa6.nice.names$vi.level=="moderate.cumulative"]<-"Moderate or worse"
asa6.nice.names$vi.level[asa6.nice.names$vi.level=="severe.cumulative"]<-"Severe or worse"
asa6.nice.names$vi.level[asa6.nice.names$vi.level=="blind.cumulative"]<-"Blind"

asa6.nice.names$female.adj.ci<-paste0(asa6.nice.names$female.adj.pct.lci," - ",asa6.nice.names$female.adj.pct.uci)
asa6.nice.names$male.adj.ci<-paste0(asa6.nice.names$male.adj.pct.lci," - ",asa6.nice.names$male.adj.pct.uci)
asa6.nice.names$total.adj.ci<-paste0(asa6.nice.names$total.adj.pct.lci," - ",asa6.nice.names$total.adj.pct.uci)
asa6.nice.names$female.ci<-paste0(asa6.nice.names$female.pct.lci," - ",asa6.nice.names$female.pct.uci)
asa6.nice.names$male.ci<-paste0(asa6.nice.names$male.pct.lci," - ",asa6.nice.names$male.pct.uci)
asa6.nice.names$total.ci<-paste0(asa6.nice.names$total.pct.lci," - ",asa6.nice.names$total.pct.uci)

asa6a.nice.names<-asa6.nice.names[,c("vi.level","female.n","female.pct","female.ci","male.n","male.pct","male.ci","total.n","total.pct","total.ci")]

write.table(asa6a.nice.names,here("outputs", ID, "summary", "data", "prev3.csv"),row.names=F,col.names=T,sep=",")

names(asa6a.nice.names)<-c("","n","%","95% CI","n","%","95% CI","n","%","95% CI")

knitr::kable(asa6a.nice.names, booktabs=T, linesep = "", caption = "Crude cumulative prevalence of blindness (any PVA <3/60), severe (any PVA <6/60) and moderate (any PVA <6/18) vision impairment (PREV3)", align='lccccccccc') %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position", font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(c(4,7,10),width='1.5cm') %>%
  column_spec(1,width='3cm') %>%
  add_header_above(c("VI level" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold = T) %>%
  add_footnote("Participants not tested at 6/12",notation="symbol")

```


```{r asa6b,echo=FALSE}

asa6b.nice.names<-asa6.nice.names[,c("vi.level","female.adj.pct","female.adj.ci","extrapolated.female.n","male.adj.pct","male.adj.ci","extrapolated.male.n","total.adj.pct","total.adj.ci","extrapolated.total.n")]

write.table(asa6b.nice.names,here("outputs", ID, "summary", "data", "prev4.csv"),row.names=F,col.names=T,sep=",")

names(asa6b.nice.names)<-c("","%","95% CI","Extrapolated magnitude","%","95% CI","Extrapolated magnitude","%","95% CI","Extrapolated magnitude")

knitr::kable(asa6b.nice.names, booktabs=T, linesep = "", caption = "Adjusted cumulative prevalence and extrapolated magnitude of blindness (any PVA <3/60), severe (any PVA <6/60) and moderate (any PVA <6/18) vision impairment (PREV4)", align='lccccccccc') %>%
  kable_styling(latex_options = c("scale_down","HOLD_position"), font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(c(4,7,10),width='2cm') %>%
  add_header_above(c("VI level" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold = T)%>%
  add_footnote("Participants not tested at 6/12",notation="symbol")

```

## Unilateral distance vision impairment prevalence

```{r newtab1a, echo=FALSE}

source(here("RAAB5_scripts","crude-adj-prev-vi-unilat_RAAB5.R"))

unt.nice.names<-unt

unt.nice.names$male.ci<-paste0(unt.nice.names$male.pct.lci," - ",unt.nice.names$male.pct.uci)
unt.nice.names$female.ci<-paste0(unt.nice.names$female.pct.lci," - ",unt.nice.names$female.pct.uci)
unt.nice.names$total.ci<-paste0(unt.nice.names$total.pct.lci," - ",unt.nice.names$total.pct.uci)

row.order<-c("blind.unilat","severe.unilat","moderate.unilat","mild.unilat")
unt.nice.names<-unt.nice.names %>% arrange(match(unt.nice.names$vi.level,row.order))

unt.nice.names$vi.level<-as.character(unt.nice.names$vi.level)
unt.nice.names$vi.level[unt.nice.names$vi.level=="mild.unilat"]<-"Mild in one eye only"
unt.nice.names$vi.level[unt.nice.names$vi.level=="moderate.unilat"]<-"Moderate in one eye only"
unt.nice.names$vi.level[unt.nice.names$vi.level=="severe.unilat"]<-"Severe in one eye only"
unt.nice.names$vi.level[unt.nice.names$vi.level=="blind.unilat"]<-"Blind in one eye only"

unta.nice.names<-unt.nice.names[,c("vi.level","female.n","female.pct","female.ci","male.n","male.pct","male.ci","total.n","total.pct","total.ci")]

write.table(unta.nice.names,here("outputs", ID, "summary", "data", "prev5.csv"),row.names=F,col.names=T,sep=",")

names(unta.nice.names) <- c(' ', 'n', '%', '95% CI', 'n', '%', '95% CI', 'n', '%', '95% CI')

knitr::kable(unta.nice.names,booktabs=T, linesep = "",caption="Crude prevalence of blind, severe and moderate unilateral vision impairment (PREV5)", align='lccccccccc') %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position"),font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='4cm') %>%
  add_header_above(c("VI level" = 1, "Male" = 3, "Female" = 3, "Total" = 3),bold=T) %>%
  add_footnote(c("Participants not tested at 6/12","Unilateral refers to cases where the other eye has PVA of 6/18"),notation="symbol")

```


```{r newtab1b, echo=FALSE}


unt.nice.names$male.adj.ci<-paste0(unt.nice.names$male.adj.pct.lci," - ",unt.nice.names$male.adj.pct.uci)
unt.nice.names$female.adj.ci<-paste0(unt.nice.names$female.adj.pct.lci," - ",unt.nice.names$female.adj.pct.uci)
unt.nice.names$total.adj.ci<-paste0(unt.nice.names$total.adj.pct.lci," - ",unt.nice.names$total.adj.pct.uci)


untb.nice.names<-unt.nice.names[,c("vi.level","female.adj.pct","female.adj.ci","extrapolated.female.n","male.adj.pct","male.adj.ci","extrapolated.male.n","total.adj.pct","total.adj.ci","extrapolated.total.n")]

write.table(untb.nice.names,here("outputs", ID, "summary", "data", "prev6.csv"),row.names=F,col.names=T,sep=",")

names(untb.nice.names) <- c("", "%","95% CI","Extrapolated magnitude","%","95% CI","Extrapolated magnitude","%","95% CI","Extrapolated magnitude")

knitr::kable(untb.nice.names, booktabs=T, linesep = "", caption="Adjusted prevalence and extrapolated magnitude of blind, severe and moderate unilateral vision impairment (PREV6)", align='lccccccccc') %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position"), font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(c(4,7,10),width='2cm') %>%
  add_header_above(c("VI level" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold=T) %>% 
  add_footnote(c("Participants not tested at 6/12","Unilateral refers to cases where the other eye has PVA of 6/18"),notation="symbol")
```

Cases of unilateral vision impairment acknowledge an additional sight loss burden in the population, not captured in the standard definition of bilateral vision impairment, but with the potential to impact on visual functioning.

\newpage

# Causes of distance vision impairment

## Principal cause by impairment level

```{r sum6, echo=FALSE}

source(here("RAAB5_scripts","cause-vi_RAAB5.R"))

sum6.nice.names<-sum6[,1:9]

sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_uncorrected_refractive_error"]<-"1. Uncorrected refractive error"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_aphakia_uncorrected"]<-"2. Uncorrected aphakia"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_cataract_untreated"]<-"3. Untreated cataract"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_cataract_surgical_complications"]<-"4. Cataract surgical complications"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_trachomatous_corneal_opacity" ]<-"5. Trachomatous corneal opacity"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_other_corneal_opacity"]<-"6. Other corneal opacity"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_phthisis" ]<-"7. Phthisis"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_onchocerciasis"]<-"8. Onchocerciasis"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_glaucoma" ]<-"9. Glaucoma"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_diabetic_retinopathy"]<-"10. Diabetic retinopathy"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_age_related_macular_degeneration"]<-"11. Age-related macular degeneration"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_other_posterior_segment_disease" ]<-"12. Other posterior segment disease"
sum6.nice.names$principal.cause[sum6.nice.names$principal.cause=="poor_vision_cause_other_globe_or_cns_abnormalities"]<-"14. Other globe or CNS abnomalities"

write.table(sum6.nice.names,file=here("outputs",ID,"summary","data","cause1.csv"),row.names=F,col.names=T,sep=",")

sum6.for.tree<-sum6.numeric

names(sum6.nice.names) <- c(' ', 'n', '%', 'n', '%','n', '%','n', '%')

knitr::kable(sum6.nice.names, booktabs=T, linesep = "", caption = " Principal cause of blindness, severe and moderate vision impairment (CAUSE1)", align='lcccccc') %>% 
  kable_styling(full_width=T,latex_options = "HOLD_position", font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(13,hline_after=T) %>%
  column_spec(1,width='6cm') %>%
  add_header_above(c("Principal cause" = 1, "Blind" = 2, "Severe" = 2, "Moderate" = 2, "Mild" = 2),bold = T) %>%
  add_footnote("Participants not tested at 6/12",notation="symbol")

```


```{r sum6_agg, echo=FALSE}

sum6intag<-aggregate(sum6.numeric[,2:9],by=list(sum6.numeric$cause_group_1), FUN=sum,na.rm=T)
sum6intag[nrow(sum6intag)+1,2:9]<-colSums(sum6intag[1:3,2:9])
sum6intag$Group.1[4]<-"D. Avoidable (A + B + C)"
s6tag<-aggregate(sum6.numeric[,2:9],by=list(sum6.numeric$cause_group_2), FUN=sum,na.rm=T)

sum6ag<-rbind(sum6intag,s6tag)

sum6ag[,c(8,9)]<-"*"

write.table(sum6ag,here("outputs", ID, "summary", "data", "cause2.csv"),row.names=F,col.names=T,sep=",")

names(sum6ag)<-c("","n", "%", "n", "%", "n","%","n","%")

knitr::kable(sum6ag, booktabs=T, linesep = c('', '', '', '\\addlinespace'), caption = " Principal cause of blindness, severe and moderate vision impairment, by intervention category CAUSE2)", align='lcccccc') %>% 
  kable_styling(full_width=T,latex_options = "HOLD_position",font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='5cm') %>%
  add_header_above(c("Category" = 1, "Blind" = 2, "Severe" = 2, "Moderate" = 2, "Mild" = 2),bold = T)%>%
  add_footnote(c("Participants not tested at 6/12","PHC: Primary Health Care; PEC: Primary Eye Care"),notation="symbol")

```

This table compares the main cause of blindness, severe vision impairment and moderate vision impairment in the person. The following shows what proportion of vision impairment is attributable to treatable, preventable and posterior segment disease. From these tables the priorities for intervention can be determined. The distribution of cases of blindness in the sample are visualised below.

```{r treemap_1, echop=FALSE, fig.fullwidth=T}

sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_uncorrected_refractive_error"]<-"Uncorrected refractive error"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_aphakia_uncorrected"]<-"Uncorrected aphakia"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_cataract_untreated"]<-"Untreated cataract"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_cataract_surgical_complications"]<-"Cataract surgical complications"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_trachomatous_corneal_opacity" ]<-"Trachomatous corneal opacity"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_other_corneal_opacity"]<-"Other corneal opacity"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_phthisis" ]<-"Phthisis"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_onchocerciasis"]<-"Onchocerciasis"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_glaucoma" ]<-"Glaucoma"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_diabetic_retinopathy"]<-"Diabetic retinopathy"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_age_related_macular_degeneration"]<-"Age-related macular degeneration"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_other_posterior_segment_disease" ]<-"Other posterior segment disease"
sum6.for.tree$principal.cause[sum6.for.tree$principal.cause=="poor_vision_cause_other_globe_or_cns_abnormalities"]<-"Other globe or CNS abnomalities"

core_fig_cols<-brewer.pal(8,"Spectral")

treemap(sum6.for.tree[1:13,],index="principal.cause",vSize="blind.pct",type="index",palette = core_fig_cols, title="Principal causes of bilateral blindness",position.legend="right",fontsize.title=12)

```

## Principal cause of blindness by gender

```{r prev4, echo=FALSE}

source(here("RAAB5_scripts","cause-blind-gender.R"))

prev4.nice.names<-prev4[,1:7]

prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_uncorrected_refractive_error"]<-"1. Uncorrected refractive error"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_aphakia_uncorrected"]<-"2. Uncorrected aphakia"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_cataract_untreated"]<-"3. Untreated cataract"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_cataract_surgical_complications"]<-"4. Cataract surgical complications"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_trachomatous_corneal_opacity" ]<-"5. Trachomatous corneal opacity"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_other_corneal_opacity"]<-"6. Other corneal opacity"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_phthisis" ]<-"7. Phthisis"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_onchocerciasis"]<-"8. Onchocerciasis"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_glaucoma" ]<-"9. Glaucoma"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_diabetic_retinopathy"]<-"10. Diabetic retinopathy"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_age_related_macular_degeneration"]<-"11. Age-related macular degeneration"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_other_posterior_segment_disease" ]<-"12. Other posterior segment disease"
prev4.nice.names$principal.cause[prev4.nice.names$principal.cause=="poor_vision_cause_other_globe_or_cns_abnormalities"]<-"14. Other globe or CNS abnomalities"

write.table(prev4.nice.names,here("outputs", ID, "summary", "data", "cause3.csv"),row.names=F,col.names=T,sep=",")

names(prev4.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(prev4.nice.names, booktabs=T, linesep = "", caption = "Principal cause of blindness (PVA<3/60) in males and females (CAUSE3)", align='lcccccc') %>% 
  kable_styling(full_width=T,latex_options = "HOLD_position", font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(13,hline_after=T) %>%
  column_spec(1,width='6cm') %>%
  add_header_above(c("Principal cause" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold = T)

```

This table shows the principal cause of blindness, disaggregated by gender.

```{r prev4_agg, echo=FALSE}

prev4ag<-rbind(prev4intag,p4tag)

write.table(prev4ag,here("outputs", ID, "summary", "data", "cause4.csv"),row.names=F,col.names=T,sep=",")

names(prev4ag)<-c("","n", "%", "n", "%", "n","%")

knitr::kable(prev4ag, booktabs=T, linesep = c('', '', '', '\\addlinespace'), caption = " Principal cause of blindness (PVA <3/60), by gender and intervention category (CAUSE4)", align='lcccccc') %>% 
  kable_styling(full_width=T,latex_options = "HOLD_position", font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='5cm') %>%
  add_header_above(c("Category" = 1, "Male" = 2, "Female" = 2, "Total" = 2),bold = T) %>% 
  add_footnote("PHC: Primary Health Care; PEC: Primary Eye Care",notation="symbol")

```

\newpage

# Cataract

## Cataract coverage

### Cataract operations

```{r catops, echo=FALSE}

source(here("RAAB5_scripts","crude_cat_ops_RAAB5.R"))

catops.nice.names<-catops

write.table(catops.nice.names,here("outputs", ID, "summary", "data", "cat1.csv"),row.names=F,col.names=T,sep=",")

catops.nice.names$cat.ops[catops.nice.names$cat.ops=="bilateral.operated"]<-"Bilateral operated"
catops.nice.names$cat.ops[catops.nice.names$cat.ops=="unilateral.operated"]<-"Unilateral operated"
catops.nice.names$cat.ops[catops.nice.names$cat.ops=="total.operated"]<-"Total operated"

names(catops.nice.names)<-c(" ","n","%","n","%","n","%")

knitr::kable(catops.nice.names, booktabs=T, linesep = "", caption = "Crude prevalence of people bilaterally and unilaterally cataract operated (CAT1)", align='lcccccc') %>%
  kable_styling(full_width=T, latex_options = "HOLD_position",font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='3cm') %>%
  add_header_above(c("Operated cataract" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T)

```

This table reports the prevalence of people in the sample with one or both eyes operated, irrespective of post-operative visual acuity or pinhole acuity in the unoperated eye.

### Unmet need for cataract surgery

```{r catcovdenom.a, echo=FALSE}

source(here("RAAB5_scripts","crude-adj-prev-cat-cov-denom_RAAB5.R"))

catcovdenom.a<-catcovdenom[,c("vi.level","female.n","female.pct","female.pct.lci","female.pct.uci","male.n","male.pct","male.pct.lci","male.pct.uci","total.n","total.pct","total.pct.lci","total.pct.uci")]

catcovdenom.a$female.ci<-paste0(catcovdenom.a$female.pct.lci," - ", catcovdenom.a$female.pct.uci)
catcovdenom.a$male.ci<-paste0(catcovdenom.a$male.pct.lci," - ", catcovdenom.a$male.pct.uci)
catcovdenom.a$total.ci<-paste0(catcovdenom.a$total.pct.lci," - ", catcovdenom.a$total.pct.uci)

catcovdenom.a.nice.names<-catcovdenom.a[,c("vi.level","female.n","female.pct","female.ci","male.n","male.pct","male.ci","total.n","total.pct","total.ci")]

write.table(catcovdenom.a.nice.names,here("outputs", ID, "summary", "data", "cat2.csv"),row.names=F,col.names=T,sep=",")

names(catcovdenom.a.nice.names)<-c(" ","n","%","95% CI","n","%","95% CI","n","%","95% CI")

knitr::kable(catcovdenom.a.nice.names, booktabs=T, linesep = "", caption = "Crude unmet need for cataract surgery at pinhole VA thresholds <3/60, <6/60 and <6/18 (CAT2)",align='lccccccccc') %>%
  kable_styling(full_width=T, latex_options = "HOLD_position",font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  add_header_above(c("Unmet need threshold" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold=T) %>%
  add_footnote("Participants not tested at 6/12",notation="symbol")

```


```{r catcovdenom.b, echo=FALSE}

source(here("RAAB5_scripts","crude-adj-prev-cat-cov-denom_RAAB5.R"))

catcovdenom.b<-catcovdenom[,c("vi.level","female.adj.pct","female.adj.pct.lci","female.adj.pct.uci","male.adj.pct","male.adj.pct.lci","male.adj.pct.uci","total.adj.pct","total.adj.pct.lci","total.adj.pct.uci","extrapolated.female.n","extrapolated.male.n","extrapolated.total.n")]

catcovdenom.b$male.adj.ci<-paste0(catcovdenom.b$male.adj.pct.lci," - ",catcovdenom.b$male.adj.pct.uci)
catcovdenom.b$female.adj.ci<-paste0(catcovdenom.b$female.adj.pct.lci," - ",catcovdenom.b$female.adj.pct.uci)
catcovdenom.b$total.adj.ci<-paste0(catcovdenom.b$total.adj.pct.lci," - ",catcovdenom.b$total.adj.pct.uci)

catcovdenom.b.nice.names<-catcovdenom.b[,c("vi.level","female.adj.pct","female.adj.ci","extrapolated.female.n","male.adj.pct","male.adj.ci","extrapolated.male.n","total.adj.pct","total.adj.ci","extrapolated.total.n")]

write.table(catcovdenom.b.nice.names,here("outputs", ID, "summary", "data", "cat3.csv"),row.names=F,col.names=T,sep=",")

names(catcovdenom.b.nice.names)<-c(" ","Adj. %", "95% CI", "Extrapolated magnitude","Adj. %", "95% CI", "Extrapolated magnitude","Adj. %", "95% CI", "Extrapolated magnitude")

knitr::kable(catcovdenom.b.nice.names, booktabs=T, linesep = "", caption = "Extrapolated magnitude of unmet need for cataract surgery at pinhole VA thresholds <3/60, <6/60, <6/18 and <6/12 (CAT3)", align='lccccccccc') %>%
  kable_styling(latex_options = c("scale_down","HOLD_position"), font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(c(4,7,10),width='2cm') %>%
  add_header_above(c("Unmet need threshold" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold=T) %>%
  add_footnote("Participants not tested at 6/12",notation="symbol")

```

The number of people at each PinVA threshold in these tables correspond to the unmet need for cataract surgery in the calculation for effective cataract surgical coverage (see notes). People with unmet need for surgery may have cataract in one or both eyes. Those with cataract in one eye and different cause of VI in the other eye would potentially benefit from cataract surgery. Note, this group with unilateral cataract excludes people with previous cataract surgery, refractive error or uncorrected aphakia in the non-cataract eye.

### Unmet need for cataract surgery by bilateral and unilateral cases

In these tables, the unmet need for cataract surgery is broken down by bilateral and unilateral cataract cases at each of the cataract surgical thresholds.

```{r asa7a, echo=FALSE}

source(here("RAAB5_scripts","adj-csc-ecsc_RAAB5.R"))
source(here("RAAB5_scripts","crude-adj-cat-vi-prev_RAAB5.R"))

asa7a.int<-asa7[,c("vi.level","female.n","female.pct","female.pct.lci","female.pct.uci","male.n","male.pct","male.pct.lci","male.pct.uci","total.n","total.pct","total.pct.lci","total.pct.uci")]

asa7a.int$female.ci<-paste0(asa7a.int$female.pct.lci," - ", asa7a.int$female.pct.uci)
asa7a.int$male.ci<-paste0(asa7a.int$male.pct.lci," - ", asa7a.int$male.pct.uci)
asa7a.int$total.ci<-paste0(asa7a.int$total.pct.lci," - ", asa7a.int$total.pct.uci)

asa7a.nice.names<-asa7a.int[,c("vi.level","female.n","female.pct","female.ci","male.n","male.pct","male.ci","total.n","total.pct","total.ci")]

write.table(asa7a.nice.names,here("outputs", ID, "summary", "data", "cat4.csv"),row.names=F,col.names=T,sep=",")

names(asa7a.nice.names)<-c(" ","n","%","95% CI","n","%","95% CI","n","%","95% CI")

knitr::kable(asa7a.nice.names, booktabs=T, linesep = "", caption = "Crude prevalence of cataract with PinVA <3/60, <6/60 and <6/18 (CAT4)", align='lccccccccc') %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position"),font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  pack_rows("Bilateral",1,4) %>%
  pack_rows("Unilateral",5,8) %>%
  add_header_above(c("Cataract surgical threshold" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold=T) %>%
  add_footnote(c("Participants not tested at 6/12","Unilateral cases can have any level of VA in the eye without operable cataract"),notation="symbol") 

```


```{r asa7b, echo=FALSE}

source(here("RAAB5_scripts","adj-csc-ecsc_RAAB5.R"))
source(here("RAAB5_scripts","crude-adj-cat-vi-prev_RAAB5.R"))

asa7b.int<-asa7[,c("vi.level","female.adj.pct","female.adj.pct.lci","female.adj.pct.uci","male.adj.pct","male.adj.pct.lci","male.adj.pct.uci","total.adj.pct","total.adj.pct.lci","total.adj.pct.uci","extrapolated.female.n","extrapolated.male.n","extrapolated.total.n")]

asa7b.int$male.adj.ci<-paste0(asa7b.int$male.adj.pct.lci," - ",asa7b.int$male.adj.pct.uci)
asa7b.int$female.adj.ci<-paste0(asa7b.int$female.adj.pct.lci," - ",asa7b.int$female.adj.pct.uci)
asa7b.int$total.adj.ci<-paste0(asa7b.int$total.adj.pct.lci," - ",asa7b.int$total.adj.pct.uci)

asa7b.nice.names<-asa7b.int[,c("vi.level","female.adj.pct","female.adj.ci","extrapolated.female.n","male.adj.pct","male.adj.ci","extrapolated.male.n","total.adj.pct","total.adj.ci","extrapolated.total.n")]

write.table(asa7b.nice.names,here("outputs", ID, "summary", "data", "cat5.csv"),row.names=F,col.names=T,sep=",")

names(asa7b.nice.names)<-c(" ","Adj. %", "95% CI", "Extrapolated magnitude","Adj. %", "95% CI", "Extrapolated magnitude","Adj. %", "95% CI", "Extrapolated magnitude")

knitr::kable(asa7b.nice.names, booktabs=T, linesep = "", caption = "Adjusted prevalence and extrapolated magnitude of cataract with PinVA <3/60, <6/60 and <6/18 (CAT5)", align='lccccccccc') %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position")) %>%
  row_spec(0,italic=TRUE) %>%
  pack_rows("Bilateral",1,4) %>%
  pack_rows("Unilateral",5,8) %>%
  column_spec(c(4,7,10),width='2cm') %>%
  add_header_above(c("Cataract surgical threshold" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold=T) %>%
  add_footnote(c("Participants not tested at 6/12","Unilateral cases can have any level of VA in the eye without operable cataract"),notation="symbol")

```

These tables enable planning the number of surgeries required to eliminate vision impairment from cataract at a particular PinVA threshold. Assuming services will aim to operate on all eyes of people with vision impairing cataract, two surgeries are required for ‘bilateral cases’ and one surgery is required for ‘unilateral cases’.

### Effective cataract surgical coverage

```{r prev14, echo=FALSE}

source(here("RAAB5_scripts","adj-csc-ecsc_RAAB5.R"))

prev14.nice.names<-prev14[prev14$num.thresh=="csc" | prev14$num.thresh=="ecsc_618",]

prev14.nice.names$male.adjusted.ci<-paste0(prev14.nice.names$male.adjusted.lci," - ",prev14.nice.names$male.adjusted.uci)
prev14.nice.names$female.adjusted.ci<-paste0(prev14.nice.names$female.adjusted.lci," - ",prev14.nice.names$female.adjusted.uci)
prev14.nice.names$total.adjusted.ci<-paste0(prev14.nice.names$total.adjusted.lci," - ",prev14.nice.names$total.adjusted.uci)

prev14.nice.names$num.thresh<-recode_factor(prev14.nice.names$num.thresh,'csc' = "CSC",'ecsc_618' = "eCSC (outcome 6/18)")

prev14a.nice.names<-prev14.nice.names[,c("num.thresh","female.adjusted","female.adjusted.ci","male.adjusted","male.adjusted.ci","total.adjusted","total.adjusted.ci","quality_gap")]

write.table(prev14a.nice.names,here("outputs", ID, "summary", "data", "cat6.csv"),row.names=F,col.names=T,sep=",")

names(prev14a.nice.names)<-c("","Adj. %","95% CI","Adj. %","95% CI","Adj. %","95% CI","")

knitr::kable(prev14a.nice.names, booktabs=T, linesep = "", caption = "Adjusted cataract surgical coverage and effective cataract surgical coverage at the person level (CAT6)",row.names=F,align='lccccccc') %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position"),font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='4cm') %>%
  pack_rows("Cataract surgical threshold <6/18",1,2) %>%
  pack_rows("Cataract surgical threshold <6/60",3,4) %>%
  pack_rows("Cataract surgical threshold <3/60",5,6) %>%
  add_header_above(c(" " = 1, "Female" = 2, "Male" = 2, "Total" = 2,"Relative Quality Gap" = 1),bold=T) %>%
  add_footnote("CSC: Cataract Surgical Coverage; eCSC: Effective Cataract Surgical Coverage",notation="symbol")


```

Effective cataract surgical coverage (eCSC) measures the number of people in a population who have been operated on for cataract, and had a good outcome (at least 6/18 post-operative presenting VA when 6/12 was not tested), as a proportion of all people operated on or still requiring surgery. Therefore, eCSC describes service access (ie, cataract surgical coverage, [CSC]) adjusted for quality. eCSC and CSC are reported at three cataract surgical thresholds. The gap between CSC and eCSC values can be considered a quality gap; the relative quality gap is calculated as (total CSC–total eCSC)/ total CSC, with lower values reflecting better quality of cataract surgical services. See notes section for more details.

### Barriers to cataract surgery

```{r sum11, echo=FALSE}

source(here("RAAB5_scripts","cat-barriers.R"))

sum11.nice.names<-surgery.bars[, c("Barrier","female_count","female_percent","male_count","male_percent","total_count","total_percent")]

write.table(sum11.nice.names,here("outputs", ID, "summary", "data", "cat7.csv"),row.names=F,col.names=T,sep=",")

names(sum11.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(sum11.nice.names,booktabs=T, linesep = "", caption="Barriers to cataract surgery among participants with bilateral cataract and PinVA <6/60 (CAT7)", align='lcccccc') %>% 
  kable_styling(full_width=T,latex_options = "HOLD_position", font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(nrow(sum11.nice.names)-1,hline_after=T) %>%
  column_spec(1,width='4cm') %>%
  add_header_above(c("Barrier" = 1, "Female" = 2, "Male" = 2, "Total" = 2)) %>%
  add_footnote("Participants can report 1 or 2 barriers each", notation="symbol")  

```

The standard RAAB survey protocol does not allow for in-depth interviews to determine why people with cataract have not yet been operated. This preliminary data on barriers to surgery should be regarded as an indication whether more detailed qualitative studies are required.

## Cataract quality

Surgical outcomes are reported for all operated eyes in the sample, not at the person level. RAAB gives population based data on post-operative visual outcomes, not specific to one surgeon or one hospital and with follow-up periods ranging from months to decades.

### Type of surgery

```{r newtab2, echo=FALSE}

source(here("RAAB5_scripts","surg-type-outcome-gender_RAAB5.R"))

newtab2.nice.names<-newtab2

newtab2.nice.names$surgery.type[newtab2.nice.names$surgery.type=="surgery_type_iol"]<-"IOL"
newtab2.nice.names$surgery.type[newtab2.nice.names$surgery.type=="surgery_type_non_iol"]<-"Non-IOL"
newtab2.nice.names$surgery.type[newtab2.nice.names$surgery.type=="surgery_type_couching"]<-"Couching"

write.table(newtab2.nice.names,here("outputs", ID, "summary", "data", "cat8.csv"),row.names=F,col.names=T,sep=",")

names(newtab2.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(newtab2.nice.names, booktabs=T, linesep = "", caption = "Type of cataract surgery performed, count by eyes (CAT8)", align='lcccccc') %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position", font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(3,hline_after=T) %>%
  add_header_above(c("Surgery type" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T)

```

### Presenting acuity vs pinhole acuity outcomes

```{r newtab3a, echo=FALSE}

source(here("RAAB5_scripts","surg-type-outcome-gender_RAAB5.R"))

newtab3a.nice.names<-newtab3a

row.order<-c("good.oc","borderline.oc","poor.oc")
newtab3a.nice.names<-newtab3a.nice.names %>% arrange(match(newtab3a.nice.names$oc.levels,row.order))
newtab3a.nice.names$oc.levels[newtab3a.nice.names$oc.levels=="good.oc"]<-"Good (6/18)"
newtab3a.nice.names$oc.levels[newtab3a.nice.names$oc.levels=="borderline.oc"]<-"Borderline (<6/18 to 6/60)"
newtab3a.nice.names$oc.levels[newtab3a.nice.names$oc.levels=="poor.oc"]<-"Poor (<6/60)"

write.table(newtab3a.nice.names,here("outputs", ID, "summary", "data", "cat9.csv"),row.names=F,col.names=T,sep=",")

names(newtab3a.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(newtab3a.nice.names, booktabs=T, linesep = "", caption = "Post-operative visual outcome (PVA), count by eyes (CAT9)", align='lcccccc') %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position", font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(3,hline_after=T) %>%
  column_spec(1,width='5cm') %>%
  add_header_above(c("Outcome (PVA)" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T) %>%
  add_footnote("Participants not tested at 6/12",notation="symbol")

```


```{r newtab3b, echo=FALSE}

newtab3b.nice.names<-newtab3b

row.order<-c("good.oc","borderline.oc","poor.oc")
newtab3b.nice.names<-newtab3b.nice.names %>% arrange(match(newtab3b.nice.names$oc.levels,row.order))
newtab3b.nice.names$oc.levels[newtab3b.nice.names$oc.levels=="good.oc"]<-"Good (6/18)"
newtab3b.nice.names$oc.levels[newtab3b.nice.names$oc.levels=="borderline.oc"]<-"Borderline (<6/18 to 6/60)"
newtab3b.nice.names$oc.levels[newtab3b.nice.names$oc.levels=="poor.oc"]<-"Poor (<6/60)"

write.table(newtab3b.nice.names,here("outputs", ID, "summary", "data", "cat10.csv"),row.names=F,col.names=T,sep=",")

names(newtab3b.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(newtab3b.nice.names, booktabs=T, linesep = "", caption = "Post-operative visual outcome (PinVA), count by eyes (CAT10)", align='lcccccc') %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position", font_size=10) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(3,hline_after=T) %>%
  column_spec(1,width='4cm') %>%
  add_header_above(c("Outcome (PinVA)" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T) %>%
  add_footnote("Participants not tested at 6/12",notation="symbol")

```

Where there is a higher proportion of good outcomes with PinVA compared to PVA, consider the availability of post-operative refraction services for cataract patients. Correction of residual distance refractive error may improve post-operative outcomes in the population. 

### Outcomes by place of surgery

```{r outc6, echo=FALSE}

source(here("RAAB5_scripts","surg-place-outcome_RAAB5.R"))

outc6a.nice.names<-male[,c("oc","male_surgery_place_gov_hospital_n","male_surgery_place_gov_hospital_percent","male_surgery_place_voluntary_hospital_n","male_surgery_place_voluntary_hospital_percent","male_surgery_place_private_hospital_n","male_surgery_place_private_hospital_percent","male_surgery_place_camp_improvised_n","male_surgery_place_camp_improvised_percent","male_surgery_place_traditional_n","male_surgery_place_traditional_percent")]

row.order<-c("good.oc","borderline.oc","poor.oc")
outc6a.nice.names<-outc6a.nice.names %>% arrange(match(outc6a.nice.names$oc,row.order))
outc6a.nice.names$oc[outc6a.nice.names$oc=="good.oc"]<-"Good (6/18)"
outc6a.nice.names$oc[outc6a.nice.names$oc=="borderline.oc"]<-"Borderline (<6/18 to 6/60)"
outc6a.nice.names$oc[outc6a.nice.names$oc=="poor.oc"]<-"Poor (<6/60)"

write.table(outc6a.nice.names,here("outputs", ID, "summary", "data", "cat11.csv"),row.names=F,col.names=T,sep=",")

names(outc6a.nice.names)<-c("","n","%","n","%","n","%","n","%","n","%")

knitr::kable(outc6a.nice.names, booktabs=T, linesep = "", caption = "Post-operative visual outcomes (PVA) in male eyes by place of surgery (CAT11)", , align='lcccccccccc') %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position"), font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(3,hline_after=T) %>%
  add_header_above(c("Post-surgical VA" = 1, "Gov. Hosp." = 2, "Vol. Hosp." = 2, "Priv. Hosp." = 2, "Camp Improv." = 2, "Trad." = 2),bold=T)

```


```{r outc6b, echo=FALSE}

outc6b.nice.names<-female[,c("oc","female_surgery_place_gov_hospital_n","female_surgery_place_gov_hospital_percent","female_surgery_place_voluntary_hospital_n","female_surgery_place_voluntary_hospital_percent","female_surgery_place_private_hospital_n","female_surgery_place_private_hospital_percent","female_surgery_place_camp_improvised_n","female_surgery_place_camp_improvised_percent","female_surgery_place_traditional_n","female_surgery_place_traditional_percent")]

row.order<-c("good.oc","borderline.oc","poor.oc")
outc6b.nice.names<-outc6b.nice.names %>% arrange(match(outc6b.nice.names$oc,row.order))
outc6b.nice.names$oc[outc6b.nice.names$oc=="good.oc"]<-"Good (6/18)"
outc6b.nice.names$oc[outc6b.nice.names$oc=="borderline.oc"]<-"Borderline (<6/18 to 6/60)"
outc6b.nice.names$oc[outc6b.nice.names$oc=="poor.oc"]<-"Poor (<6/60)"

write.table(outc6b.nice.names,here("outputs", ID, "summary", "data", "cat12.csv"),row.names=F,col.names=T,sep=",")

names(outc6b.nice.names)<-c("","n","%","n","%","n","%","n","%","n","%")

knitr::kable(outc6b.nice.names, booktabs=T, linesep = "", caption = "Post-operative visual outcomes (PVA) in female eyes by place of surgery (CAT12)", align='lcccccccccc') %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position"), font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(3,hline_after=T) %>%
  add_header_above(c("Post-surgical VA" = 1, "Gov. Hosp." = 2, "Vol. Hosp." = 2, "Priv. Hosp." = 2, "Camp Improv." = 2, "Trad." = 2),bold=T)

```

Variation in outcome by place of surgery allows for monitoring of quality across providers. Where providers are outliers, in terms of poor quality, steps to address this should be incorporated in service planning.

Gov. Hosp. = Government hospital

Vol. Hosp .= NGO hospital

Priv. Hosp. = Private hospital

Camp Improv. = Improvised surgical camp

Trad. = Traditional setting

\newpage

# Notes

## Abbreviations

CI = Confidence interval

CNS = Central nervous system

CSC = Cataract surgical coverage

eCSC = Effective cataract surgical coverage

NGO = Nongovernmental organisation

PinVA = Pinhole visual acuity

PVA = Presenting visual acuity

VI = Vision impairment

## Snellen to logMAR conversion

Historic RAAB survey data variables have been updated to align with RAAB7 variable names and levels. RAAB7 records visual acuity in logMAR notation (or a code number representing light perception)

0.47 = Can see 6/18

1.0 = Cannot see 6/18 but can see 6/60

1.3 = Cannot see 6/60 but can see 3/60

1.8 = Cannot see 3/60 but can see 1/60

3 = Light perception

4 = No light perception

## Bilateral VI

Blindness: PVA less than 3/60 in the better eye

Severe VI: PVA less than 6/60 to 3/60 in the better eye

Moderate VI: PVA less than 6/18 to 6/60 in the better eye

## Unilateral VI

Blindness: PVA less than 3/60 in one eye, PVA 6/18 in the other eye

Severe VI: PVA less than 6/60 to 3/60 in one eye, PVA 6/18 in the other eye

Moderate VI: PVA less than 6/18 to 6/60 in one eye, PVA 6/18 in the other eye

## Cataract surgical coverage (CSC) and effective cataract surgical coverage (eCSC)

eCSC and CSC are calculated at the person level, not by eyes, and calculated at various cataract surgical thresholds.

CSC is defined as (X + Y) / (X + Y + Z)

eCSC is defined as (A + B) / (X + Y + Z)

where, e.g., at the <6/18 cataract surgical threshold:

A = individuals with unilateral operated cataract attaining 6/18 or better post-operative presenting VA in the operated eye, who have BCVA <6/18 in the other eye

B = individuals with bilateral operated cataract attaining 6/18 or better post-operative presenting VA in at least one eye

X = individuals with unilateral operated cataract (regardless of visual acuity in the operated eye) and BCVA <6/18 in the other eye

Y = individuals with bilateral operated cataract (regardless of visual acuity in the operated eyes)

Z = individuals with BCVA <6/18 in both eyes with cataract as the main cause of vision impairment in one or both eyes

Cataract surgical threshold (operable cataract): PinVA at \<3/60, \<6/60 and \<6/18 thresholds plus lens opacity plus untreated cataract as principal cause

Operated cataract: Aphakia (excluding couched eyes) or pseudophakia (with or without posterior capsule opacification [PCO]) or no view of lens but cataract surgical complications as cause of vision impairment

As 6/18 is the lowest level of VA screened, this is used to define a good post-operative visual acuity outcome

For more information see: McCormick I, Butcher R, Evans JR et al. Effective cataract surgical coverage in adults aged 50 years and older: estimates from population-based surveys in 55 countries. Lancet Global Health. 2022. https://doi.org/10.1016/S2214-109X(22)00419-3

## Cataract surgical outcomes

Operated eyes: Aphakia or pseudophakia (with or without posterior capsule opacification [PCO]) or no view of lens but cataract surgical complications as cause of vision impairment

Note that couched eyes are excluded from tables reporting on CSC/eCSC but are included in the 'Surgical outcomes' tables.

As 6/18 is the lowest level of VA screened, this is used to define a good post-operative visual acuity outcome

## 95% Confidence Interval

The 95% confidence intervals are based on standard errors calculated for the clustering of the sample and the variability between clusters, specifically using the formula provided by:

Bennett S, Woods T, Liyanage WM, Smith DL. A simplified general method for cluster-sample surveys of health in developing countries. World Health Stat Q. 1991;44(3):98-106.

```{r big_boi_maker, include=FALSE}

source(here("RAAB5_scripts","SUMMARY_OUT_RAAB5.R"))

write.table(bigboi,here("outputs", ID, "summary", "web_summary.csv"),row.names=F,col.names=T,sep=",",na="")

```

